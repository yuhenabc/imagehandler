/*! imageHandler 2015-06-07 */
!function(a){a.imageHandler={},a.imageHandler.init=function(){var b=a('<div id="ih-view"></div>'),c=a('<div id="ih-panel"></div>'),d=a('<div id="ih-show-area"><img id="ih-target"/></div>'),e=a('<div id="ih-confirm-area"></div>');e.append(a("")),c.append(d),c.append(e);var f=[];f.push('<input type="hidden" id="ih-crop-x"/>'),f.push('<input type="hidden" id="ih-crop-y"/>'),f.push('<input type="hidden" id="ih-crop-w"/>'),f.push('<input type="hidden" id="ih-crop-h"/>'),b.append(c),b.append(a(f.join("\n"))),b.appendTo(a(document.body)),b.height(a(window).height()).width(a(window).width()),a(b).hide()},a.imageHandler.updateInfo=function(b){a("#ih-crop-x").val(b.x),a("#ih-crop-y").val(b.y),a("#ih-crop-w").val(b.w),a("#ih-crop-h").val(b.h)},a.imageHandler.clearInfo=function(){a("#ih-crop-x").val(""),a("#ih-crop-y").val(""),a("#ih-crop-w").val(""),a("#ih-crop-h").val("")},a.imageHandler.create=function(b){function c(b){var c=a("#ih-view");c.is(":hidden")&&c.fadeIn();var d=a("#ih-target").get(0),e=new FileReader;e.onload=function(b){d.src=b.target.result,a(d).unbind();var c=a(".jcrop-holder");c.length>0&&(a.Jcrop(d).destroy(),c.remove()),d.onload=function(){var b,c,e;a(d).Jcrop({minSize:h.cropMinSize,aspectRatio:h.cropRatio,boxWidth:h.boxSize[0],boxHeight:h.boxSize[1],bgFade:!0,bgOpacity:.3,onSelect:a.imageHandler.updateInfo,onRelease:a.imageHandler.clearInfo},function(){var a=this.getBounds();c=a[0],e=a[1],b=this})}},e.readAsDataURL(b)}function d(){var b=a(h.fileInputId).get(0).files[0];if("undefined"==typeof b)return void console.log("请选择一张图片");var d=/^(image\/jpeg|image\/png)$/i;if(!d.test(b.type))return void console.log("仅支持 png 和 jpg 格式的图片");if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return void console.log("您的浏览器不支持 HTML5，请更换浏览器！");var f=[0,0],g=new Image,i=new FileReader;i.readAsDataURL(b),i.onload=function(a){g.src=a.target.result,g.onload=function(){f=[this.width,this.height],h.cropRatio>=0?f[0]<h.cropMinSize[0]||f[1]<h.cropMinSize[1]?console.log("请选择大于"+h.cropMinSize[0]+"x"+h.cropMinSize[1]+"图片"):f[0]/f[1]==h.cropRatio?f[0]>h.targetSize[0]?h.success(e(g,h.targetSize[0],h.targetSize[1])):h.success(e(g,f[0],f[1])):c(b):f[0]>h.boxSize[0]||f[1]>h.boxSize[1]?f[0]/f[1]>h.boxSize[0]/h.boxSize[1]?h.success(e(g,h.boxSize[0],Math.round(f[1]*h.boxSize[0]/f[0]))):f[0]/f[1]<h.boxSize[0]/h.boxSize[1]?h.success(e(g,Math.round(f[0]*h.boxSize[1]/f[1]),h.boxSize[1])):h.success(e(g,h.boxSize[0],h.boxSize[1])):h.success(g.src.split(";base64,")[1])}}}function e(b,c,d){var e=new Image;e.src=b.src;var f=document.createElement("canvas");a(f).attr("width",c),a(f).attr("height",d),a(f).hide();var g=f.getContext("2d");g.drawImage(e,0,0,c,d);var h=f.toDataURL("image/png");return h.split(";base64,")[1]}function f(b,c,d,e,f){var g=new Image;g.src=b.src;var h=document.createElement("canvas");a(h).attr("width",e),a(h).attr("height",f),a(h).hide();var i=h.getContext("2d");i.drawImage(g,c,d,e,f,0,0,e,f);var j=h.toDataURL("image/png");return j.split(";base64,")[1]}function g(){var b,c=Math.round(parseFloat(a("#ih-crop-x").val()))||0,d=Math.round(parseFloat(a("#ih-crop-y").val()))||0,g=Math.round(parseFloat(a("#ih-crop-w").val()))||0,i=Math.round(parseFloat(a("#ih-crop-h").val()))||0,j=a("#ih-target").get(0);if(0==g||0==i)console.log("请拖动鼠标来剪裁图片！");else if(g<=h.targetSize[0])b=f(j,c,d,g,i),h.success(b);else{b=f(j,c,d,g,i);var k="data:image/png;base64,"+b,l=new Image;l.src=k,b=e(l,h.targetSize[0],h.targetSize[1]),h.success(b)}}var h=a.extend({},a.imageHandler.defaults,b);h.fileInputId="#"+h.fileInputId,h.fileInputId&&a(h.fileInputId).change(function(){d();var b=a('<div id="ih-confirm-btn"><span>确定</span><input type="submit" /></div>'),c=a('<div id="ih-quit-btn"><span>取消</span><input type="button" /></div>');b.click(function(){g(),a.imageHandler.clearInfo()}),c.click(function(){var b=a("#ih-view");b.is(":visible")&&b.hide(),a.imageHandler.clearInfo()});var e=a("#ih-confirm-area");e.empty(),e.append(b),e.append(c)})},a.imageHandler.defaults={imageMaxKB:null,boxSize:[640,420],cropInitSize:[160,75],targetSize:[640,300],cropMinSize:[320,150],cropRatio:32/15,fileInputId:null,success:function(a){console.log(a)},error:function(a){console.log(a.message)}}}(jQuery);