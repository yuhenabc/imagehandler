/*! imageHandler 2015-11-16 */
!function(a){a.imageHandler={},a.imageHandler.init=function(){if(!window.isImageHandlerInited){var b=a.imageHandler;b.view=a('<div id="ih-view"></div>'),b.panel=a('<div id="ih-panel"></div>'),b.target=a('<img id="ih-target"/>'),b.show_area=a('<div id="ih-show-area"></div>'),b.show_area.append(b.target),b.confirm_area=a('<div id="ih-confirm-area"></div>'),b.panel.append(b.show_area),b.panel.append(b.confirm_area),b.view.append(b.panel),b.view.hide(),b.view.appendTo(a(document.body)),b.view.height(document.documentElement.clientHeight),window.onresize=function(){b.view.height(document.documentElement.clientHeight)},window.isImageHandlerInited=!0}},a.imageHandler.cropX=0,a.imageHandler.cropY=0,a.imageHandler.cropW=0,a.imageHandler.cropH=0,a.imageHandler.updateInfo=function(b){var c=a.imageHandler;c.cropX=b.x,c.cropY=b.y,c.cropW=b.w,c.cropH=b.h},a.imageHandler.clearInfo=function(){var b=a.imageHandler;b.cropX=0,b.cropY=0,b.cropW=0,b.cropH=0},a.imageHandler.show=function(){var b=a.imageHandler;return b.view.is(":hidden")&&b.view.fadeIn(),b},a.imageHandler.hide=function(){var b=a.imageHandler;return b.view.is(":visible")&&b.view.hide(),b},a.imageHandler.create=function(b){function c(b){h.show();var c=h.target.get(0),d=new FileReader;d.onload=function(b){c.src=b.target.result,a(c).unbind();var d=a(".jcrop-holder");d.length>0&&(a.Jcrop(c).destroy(),d.remove()),c.onload=function(){var b,d,e;a(c).Jcrop({minSize:i.cropMinSize,aspectRatio:i.cropRatio,boxWidth:i.boxSize[0],boxHeight:i.boxSize[1],bgFade:!0,bgOpacity:.3,onSelect:h.updateInfo,onRelease:h.clearInfo},function(){var a=this.getBounds();d=a[0],e=a[1],b=this})}},d.readAsDataURL(b)}function d(){var a=j.get(0).files[0];if("undefined"==typeof a)return void i.error("请选择一张图片");var b=/^(image\/jpeg|image\/png)$/i;if(!b.test(a.type))return void i.error("仅支持 png 和 jpg 格式的图片");if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return void i.error("您的浏览器不支持 HTML5，请更换浏览器！");var d=[0,0],f=new Image,g=new FileReader;g.readAsDataURL(a),g.onload=function(b){f.src=b.target.result,f.onload=function(){d=[this.width,this.height],i.cropRatio>=0?d[0]<i.cropMinSize[0]||d[1]<i.cropMinSize[1]?i.error("请选择大于"+i.cropMinSize[0]+"x"+i.cropMinSize[1]+"图片"):d[0]/d[1]==i.cropRatio?d[0]>i.targetSize[0]?i.success(e(f,d[0],d[1],i.targetSize[0],i.targetSize[1])):i.success(f.src):c(a):d[0]>i.targetSize[0]||d[1]>i.targetSize[1]?d[0]/d[1]>i.targetSize[0]/i.targetSize[1]?i.success(e(f,d[0],d[1],i.targetSize[0],Math.round(d[1]*i.targetSize[0]/d[0]))):d[0]/d[1]<i.targetSize[0]/i.targetSize[1]?i.success(e(f,d[0],d[1],Math.round(d[0]*i.targetSize[1]/d[1]),i.targetSize[1])):i.success(e(f,d[0],d[1],i.targetSize[0],i.targetSize[1])):i.success(f.src)}}}function e(a,b,c,d,e){var f=document.createElement("canvas");f.width=d,f.height=e;var g=f.getContext("2d");return g.drawImage(a,0,0,b,c,0,0,d,e),f.toDataURL()}function f(a,b,c,d,e){var f=document.createElement("canvas");f.width=d,f.height=e;var g=f.getContext("2d");return g.drawImage(a,b,c,d,e,0,0,d,e),f.toDataURL()}function g(){var b,c=a("#ih-target").get(0);if(0==h.cropW||0==h.cropH)i.error("请拖动鼠标来剪裁图片！");else if(i.cropRatio&&h.cropW<=i.targetSize[0])b=f(c,h.cropX,h.cropY,h.cropW,h.cropH),i.success&&i.success(b),h.hide();else{b=f(c,h.cropX,h.cropY,h.cropW,h.cropH);var d=new Image;d.src=b,d.onload=function(){var a=[this.width,this.height];i.cropRatio?i.success(e(d,a[0],a[1],i.targetSize[0],i.targetSize[1])):a[0]>i.targetSize[0]||a[1]>i.targetSize[1]?a[0]/a[1]>i.targetSize[0]/i.targetSize[1]?i.success(e(d,a[0],a[1],i.targetSize[0],Math.round(a[1]*i.targetSize[0]/a[0]))):a[0]/a[1]<i.targetSize[0]/i.targetSize[1]?i.success(e(d,a[0],a[1],Math.round(a[0]*i.targetSize[1]/a[1]),i.targetSize[1])):i.success(e(d,a[0],a[1],i.targetSize[0],i.targetSize[1])):i.success(b)},h.hide()}}var h=a.imageHandler;h.init();var i=a.extend({},a.imageHandler.defaults,b),j=a("#"+i.fileInputId);j.length>0&&j.change(function(){d();var b=a('<div id="ih-confirm-btn">确定</div>'),c=a('<div id="ih-cancel-btn">取消</div>');b.click(function(){g(),h.clearInfo(),j.val("")}),c.click(function(){h.hide(),h.clearInfo(),j.val("")}),h.confirm_area.empty().append(b).append(c)})},a.imageHandler.defaults={imageMaxKB:null,boxSize:[640,420],targetSize:[1e3,1e3],cropInitSize:[100,100],cropMinSize:[50,50],cropRatio:0,fileInputId:null,success:function(a){console.log(a)},error:function(a){console.log(a)}}}(jQuery);